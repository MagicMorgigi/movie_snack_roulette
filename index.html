<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie & Snack Roulette v19</title>
    <link href="https://fonts.googleapis.com/css2?family=Limelight&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --dark: #0a0a0a; --card: #1e1e1e; --text: #e0e0e0; --bg-input: #333; --gold: #ffcc00; --danger: #d93025; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--dark); color: var(--text); margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- 1. LOADING SCREEN --- */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 2s ease-in-out, visibility 2s;
        }
        #loadingOverlay.hidden { opacity: 0; visibility: hidden; }
        .loading-gif { max-width: 80%; max-height: 50vh; border-radius: 12px; box-shadow: 0 0 30px rgba(0,0,0,0.8); opacity: 0; transition: opacity 0.5s; }
        .loading-gif.loaded { opacity: 1; }

        /* --- 2. CINEMA MARQUEE --- */
        .marquee-wrapper {
            margin-top: 40px; margin-bottom: 40px;
            perspective: 800px; z-index: 100;
            width: 100%; max-width: 850px;
            display: flex; justify-content: center;
            transform: translateY(0) scale(1); 
            transition: transform 2.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .marquee-wrapper.in-center { transform: translateY(40vh) scale(1.1); }

        .cinema-sign {
            font-family: 'Limelight', cursive;
            background-color: #1a0505; color: #333;
            padding: 25px 50px; border-radius: 8px; text-align: center; text-transform: uppercase; position: relative;
            border: 4px solid #330000;
            box-shadow: 0 0 0 2px #000, 0 0 0 6px #440000, inset 0 0 20px #000;
            opacity: 0; transition: opacity 1.5s ease-in;
        }
        .cinema-sign.visible { opacity: 1; }
        .cinema-sign.flicker-start { animation: text-flicker-intro 2.5s forwards; }
        .cinema-sign.stable-on {
            color: #eee;
            text-shadow: 0 0 2px rgba(255,255,255,0.5), 0 0 8px rgba(255, 204, 0, 0.4); 
            border-color: #550000;
            box-shadow: 0 0 0 2px #000, 0 0 0 6px #660000, 0 0 15px rgba(229, 9, 20, 0.2), inset 0 0 20px #000;
        }
        .cinema-sign h1 { margin: 0; font-size: 2.5rem; letter-spacing: 3px; line-height: 1.2; }

        @keyframes text-flicker-intro {
            0% { color: #333; text-shadow: none; }
            10% { color: #fff; text-shadow: 0 0 10px var(--gold); }
            15% { color: #333; text-shadow: none; }
            30% { color: #fff; text-shadow: 0 0 15px var(--gold); }
            35% { color: #333; text-shadow: none; }
            50% { color: #444; text-shadow: none; }
            70% { color: #fff; text-shadow: 0 0 10px var(--gold); }
            100% { color: #eee; text-shadow: 0 0 2px rgba(255,255,255,0.5), 0 0 8px rgba(255, 204, 0, 0.4); }
        }

        /* --- 3. MAIN CONTENT --- */
        #mainContent {
            width: 100%; max-width: 850px;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; transform: translateY(30px);
            transition: opacity 2s ease, transform 2s ease;
            pointer-events: none;
        }
        #mainContent.fade-in { opacity: 1; transform: translateY(0); pointer-events: all; }

        /* --- UI COMPONENTS --- */
        .wrapper { width: 100%; max-width: 850px; padding-bottom: 50px; }
        .control-panel { background: #252525; border-radius: 12px; padding: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); margin-bottom: 30px; width: 100%; box-sizing: border-box; }
        .row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .full-width { width: 100%; flex: 1 1 100%; }
        .slider-row { margin-bottom: 25px; display: block; width: 100%; }
        label { font-size: 0.9rem; color: #ccc; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; }
        .val-display-large { color: var(--primary); font-weight: bold; font-size: 1.3rem; }
        .val-display { color: var(--primary); font-weight: bold; }
        select, input[type="number"], input[type="text"] { background: var(--bg-input); color: white; border: 1px solid #444; padding: 12px; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1rem; appearance: none; }
        input[type="range"] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; margin: 5px 0; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 8px; background: #444; border-radius: 5px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--primary); margin-top: -8px; border: 2px solid #fff; }
        
        .toggle-btn { background: transparent; border: 1px solid #555; color: #aaa; padding: 10px; width: 100%; cursor: pointer; border-radius: 6px; font-size: 0.85rem; margin-top: 10px; transition: 0.2s; text-align: center; }
        .toggle-btn:hover { background: #333; color: white; border-color: #888; }
        
        .btn-gen { background: linear-gradient(135deg, #e50914, #b20710); color: white; border: none; padding: 18px; font-size: 1.2rem; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4); margin-top: 25px; transition: transform 0.2s; }
        .btn-gen:active { transform: scale(0.98); }
        .btn-gen:disabled { opacity: 0.5; cursor: wait; }

        .chip-container { display: flex; flex-wrap: wrap; gap: 10px; padding: 5px; background: #1a1a1a; border-radius: 6px; margin-bottom: 15px; }
        .chip-container.centered { justify-content: center; }
        .chip { background: #333; padding: 10px 18px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; user-select: none; border: 1px solid transparent; transition: 0.2s; color: #ddd; }
        .chip:hover { background: #444; }
        .chip.active { background: var(--primary); color: white; border-color: #ff4f58; font-weight: bold; }
        
        .hidden-section { display: none; padding-top: 15px; border-top: 1px solid #444; animation: fadeIn 0.3s; margin-top: 15px; }
        .hidden-section.show { display: block; }

        /* --- SNACK EDITOR STYLES --- */
        .snack-list { max-height: 200px; overflow-y: auto; background: #111; border-radius: 6px; margin-bottom: 15px; padding: 10px; border: 1px solid #333; }
        .snack-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .snack-item:last-child { border-bottom: none; }
        .snack-info { display: flex; align-items: center; gap: 10px; }
        .delete-btn { background: transparent; border: 1px solid var(--danger); color: var(--danger); border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; }
        .delete-btn:hover { background: var(--danger); color: white; }
        .add-snack-form { display: flex; gap: 10px; margin-bottom: 10px; }
        .add-snack-form input, .add-snack-form select { flex: 1; padding: 8px; font-size: 0.9rem; }
        .btn-small { background: #333; color: white; border: 1px solid #555; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn-small:hover { background: #555; }

        /* --- RESULTS CARD --- */
        .card { background: var(--card); border-radius: 12px; overflow: hidden; display: none; flex-direction: column; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; }
        .media-split { display: flex; gap: 25px; padding: 25px; align-items: flex-start; }
        .poster-area { display: flex; align-items: center; gap: 10px; flex: 0 0 auto; }
        .poster-img { width: 150px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
        .cover-nav-btn { background: rgba(255,255,255,0.1); color: white; border: none; width: 40px; height: 60px; border-radius: 8px; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
        .cover-nav-btn:hover:not(:disabled) { background: var(--primary); transform: scale(1.1); }
        .cover-nav-btn:disabled { opacity: 0.2; cursor: default; }
        .details-wrapper { flex: 1; display: flex; flex-direction: column; }
        .card h2 { margin: 0 0 5px 0; font-size: 1.6rem; color: #fff; line-height: 1.2; }
        .meta-line { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; font-size: 0.9rem; color: #aaa; }
        .rating-star { color: #f5c518; font-weight: bold; font-size: 1.1rem; }
        .desc { font-size: 0.95rem; line-height: 1.6; color: #ccc; margin-bottom: 20px; }
        .provider-section { background: #2a2a2a; padding: 12px; border-radius: 8px; margin-top: auto; border: 1px solid #333; }
        .provider-header { font-size: 0.85rem; color: #fff; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .prov-cat { margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .prov-label { font-size: 0.75rem; color: #aaa; width: 50px; flex-shrink: 0; }
        .provider-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .provider-icon { width: 35px; height: 35px; border-radius: 6px; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; background: black; width: 100%; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .snack-content { text-align: center; padding: 40px 20px; }
        .snack-dynamic-header { font-weight: 300; margin-bottom: 20px; display: block; }
        .snack-visual-row { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .snack-emoji { font-size: 6rem; display: block; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        @media (max-width: 600px) {
            .media-split { flex-direction: column; align-items: center; text-align: center; }
            .poster-area { margin-bottom: 20px; width: 100%; justify-content: center; }
            .meta-line { justify-content: center; }
            .provider-section { text-align: left; }
            .cinema-sign h1 { font-size: 1.5rem; }
            .marquee-wrapper.in-center { transform: translateY(35vh) scale(1.1); }
            .add-snack-form { flex-direction: column; }
        }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <img id="introGif" src="" alt="Loading..." class="loading-gif">
</div>

<div class="wrapper">
    <div id="mainMarquee" class="marquee-wrapper in-center">
        <div id="cinemaSign" class="cinema-sign">
            <h1>Movie & Snack<br>Roulette</h1>
        </div>
    </div>

    <div id="mainContent">
        
        <div class="control-panel">
            <div class="row">
                <div class="full-width">
                    <label>F√ºr was ben√∂tigst du einen Vorschlag?</label>
                    <select id="appMode" onchange="updateUI()">
                        <option value="both">Kombination: Film/Serie + Snack</option>
                        <option value="media">Nur Film oder Serie</option>
                        <option value="snack">Nur Snack</option>
                    </select>
                </div>
            </div>

            <div id="mandatoryFilters">
                
                <div class="row">
                    <div class="full-width" style="text-align: center;">
                        <div class="chip-container centered" id="mediaTypeContainer">
                            <div class="chip active" onclick="toggleMediaType('movie', this)">Film</div>
                            <div class="chip" onclick="toggleMediaType('tv', this)">Serie</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div style="flex: 1;">
                        <label>Trailer-Sprache</label>
                        <select id="trailerLang">
                            <option value="en" selected>Englisch</option>
                            <option value="de">Deutsch</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>Verf√ºgbar in (Land)</label>
                        <select id="countrySelect"></select>
                    </div>
                </div>

                <div class="slider-row">
                    <label>Min. √ò-Bewertung [0 - 10]: <span id="ratingVal" class="val-display-large">7.0</span></label>
                    <input type="range" id="minRating" min="0" max="10.0" step="0.1" value="7.0" oninput="document.getElementById('ratingVal').innerText = parseFloat(this.value).toFixed(1)">
                </div>

                <button class="toggle-btn" onclick="toggleMovieFilters()">‚öôÔ∏è Erweiterte Film-Filter (Genre, Jahr...)</button>
                
                <div id="movieFiltersSection" class="hidden-section">
                    <div class="row"><div class="full-width"><label>Genre (Mehrfachauswahl m√∂glich)</label><div id="genreBox" class="chip-container">Lade...</div></div></div>
                    <div class="row"><div class="full-width"><label>Fr√ºhestes Jahr</label><select id="minYearSelect"><option value="">Beliebig</option></select></div></div>
                    <div class="slider-row"><label>Max. Laufzeit: <span id="runtimeVal" class="val-display">Alle</span></label><input type="range" id="maxRuntime" min="30" max="240" step="5" value="240" oninput="updateRuntimeDisplay(this.value)"></div>
                    <div class="slider-row"><label>Min. Votes: <span id="voteCountVal" class="val-display">200</span></label><input type="range" id="minVotes" min="20" max="500" step="10" value="200" oninput="document.getElementById('voteCountVal').innerText = this.value"></div>
                </div>
            </div>

            <div id="snackFilters" class="hidden">
                <hr style="border-color: #444; margin: 25px 0;">
                <div class="full-width" style="text-align: center;">
                    <label style="margin-bottom:15px; justify-content: center;">Snack-Pr√§ferenz</label>
                    <div class="chip-container centered" id="snackChipContainer">
                        <div class="chip active" onclick="toggleSnackType(this)" data-type="sweet">S√º√ü</div>
                        <div class="chip active" onclick="toggleSnackType(this)" data-type="salty">Salzig</div>
                    </div>
                </div>

                <button class="toggle-btn" onclick="toggleSnackEditor()">üçø Snack-Datenbank bearbeiten</button>
                
                <div id="snackEditorSection" class="hidden-section">
                    <div style="background:#222; padding:15px; border-radius:8px;">
                        <label style="color:var(--primary); margin-bottom:10px;">Neuen Snack hinzuf√ºgen</label>
                        <div class="add-snack-form">
                            <input type="text" id="newSnackName" placeholder="Name">
                            <input type="text" id="newSnackEmoji" placeholder="Emoji" style="flex:0 0 60px;">
                            <select id="newSnackType" style="flex:0 0 90px;">
                                <option value="salty">Salzig</option>
                                <option value="sweet">S√º√ü</option>
                            </select>
                            <button class="btn-small" onclick="addCustomSnack()">+</button>
                        </div>
                        <div id="snackListDisplay" class="snack-list"></div>
                        <button class="btn-small" onclick="resetSnacks()" style="width:100%; border-color:#555; color:#aaa; font-size:0.8rem;">üîÑ Reset DB</button>
                    </div>
                </div>
            </div>

            <button id="genBtn" class="btn-gen" onclick="startGeneration()">üé≤ Vorschlag generieren üé≤</button>
        </div>

        <div style="width: 100%;">
            <div id="mediaCard" class="card">
                <div class="media-split">
                    <div class="poster-area">
                        <button class="cover-nav-btn" id="btnMPrev" onclick="navigate('media', -1)">‚ùÆ</button>
                        <img id="mPoster" class="poster-img" src="" alt="Cover">
                        <button class="cover-nav-btn" id="btnMNext" onclick="navigate('media', 1)">‚ùØ</button>
                    </div>
                    <div class="details-wrapper">
                        <h2 id="mTitle">Titel</h2>
                        <div class="meta-line">
                            <span class="rating-star">‚≠ê <span id="mRating">0.0</span></span>
                            <span id="mVotes">(0)</span>
                            <span id="mYear">JAHR</span>
                        </div>
                        <p id="mDesc" class="desc">Beschreibung...</p>
                        <div class="provider-section">
                            <div id="providerHeader" class="provider-header">Verf√ºgbarkeit wird geladen...</div>
                            <div id="mProvidersContent"></div>
                        </div>
                    </div>
                </div>
                <div id="mVideo" class="video-container"></div>
            </div>

            <div id="snackCard" class="card">
                <div class="snack-content">
                    <h3 id="snackDynamicHeader" class="snack-dynamic-header"></h3>
                    <div class="snack-visual-row">
                        <button class="cover-nav-btn" id="btnSPrev" onclick="navigate('snack', -1)">‚ùÆ</button>
                        <span id="sEmoji" class="snack-emoji">üçø</span>
                        <button class="cover-nav-btn" id="btnSNext" onclick="navigate('snack', 1)">‚ùØ</button>
                    </div>
                    <h2 id="sName" style="color: var(--primary);">Snack Name</h2>
                    <p id="sDesc" class="desc">Beschreibung</p>
                </div>
            </div>
        </div>
    </div> 
</div>

<script>
    const API_KEY = 'e8c5518823a55382429cd9a7f3ab1e1a'; 

    const GIF_DURATION = 5000;         
    const PAUSE_DARK_SCREEN = 0;     

    const introGifs = [];
    for (let i = 1; i <= 28; i++) { introGifs.push(`./gifs/intro${i}.gif`); }

    const defaultSnacks = [ 
        { name: "Popcorn (Salzig)", type: "salty", icon: "üçø", desc: "Der absolute Klassiker." }, 
        { name: "Nachos & K√§se", type: "salty", icon: "üßÄ", desc: "K√§sig, warm, lecker." }, 
        { name: "Tortilla Chips", type: "salty", icon: "üå∂Ô∏è", desc: "Knusprig mit Dip." }, 
        { name: "Schoko-N√ºsse", type: "sweet", icon: "üç´", desc: "S√º√ü und knackig." }, 
        { name: "Gummib√§rchen", type: "sweet", icon: "üß∏", desc: "Fruchtig weich." }, 
        { name: "Eiscreme", type: "sweet", icon: "üç¶", desc: "L√∂ffel raus!" }, 
        { name: "Salzstangen", type: "salty", icon: "ü•®", desc: "Der leichte Knabberspa√ü." }, 
        { name: "Cookies", type: "sweet", icon: "üç™", desc: "Perfekt zu Milch." }, 
        { name: "M&Ms", type: "sweet", icon: "üç¨", desc: "Schmilzt im Mund, nicht in der Hand." }, 
        { name: "Pistazien", type: "salty", icon: "ü•ú", desc: "Harte Schale, leckerer Kern." } 
    ];

    let snackDB = [];
    let selectedMediaTypes = ['movie']; // Default nur Film

    const state = { media: { history: [], index: -1 }, snack: { history: [], index: -1 }, genres: { movie: [], tv: [] }, selectedGenres: [] };
    let introDone = false;

    window.onload = async () => {
        window.scrollTo(0,0);
        loadSnacksFromStorage();
        startIntroSequence();
        populateYearPicker();
        await loadCountries();
        await loadGenres();
        updateUI();
    };

    // --- NEUE FILTER LOGIKEN ---
    function toggleMovieFilters() { document.getElementById('movieFiltersSection').classList.toggle('show'); }
    function toggleSnackEditor() { document.getElementById('snackEditorSection').classList.toggle('show'); }

    // Media Type Logic (Multi Select)
    function toggleMediaType(type, el) {
        el.classList.toggle('active');
        if(selectedMediaTypes.includes(type)) {
            selectedMediaTypes = selectedMediaTypes.filter(t => t !== type);
        } else {
            selectedMediaTypes.push(type);
        }
        // Genre neu laden basierend auf der Auswahl? 
        // Einfachheitshalber laden wir Genres f√ºr den zuletzt geklickten Typ oder Movie als Fallback
        if(type) loadGenres(type); 
    }

    // Snack Type Logic (Multi Select)
    function toggleSnackType(el) {
        el.classList.toggle('active');
    }

    // --- DB LOGIC ---
    function loadSnacksFromStorage() {
        const stored = localStorage.getItem('mySnacks');
        snackDB = stored ? JSON.parse(stored) : [...defaultSnacks];
        renderSnackEditorList();
    }
    function saveSnacksToStorage() {
        localStorage.setItem('mySnacks', JSON.stringify(snackDB));
        renderSnackEditorList();
    }
    function addCustomSnack() {
        const name = document.getElementById('newSnackName').value;
        const emoji = document.getElementById('newSnackEmoji').value || 'üòã';
        const type = document.getElementById('newSnackType').value;
        if (!name) return alert("Name fehlt!");
        snackDB.push({ name: name, type: type, icon: emoji, desc: "Eigener Snack" });
        saveSnacksToStorage();
        document.getElementById('newSnackName').value = '';
    }
    function deleteSnack(index) {
        if (confirm("L√∂schen?")) { snackDB.splice(index, 1); saveSnacksToStorage(); }
    }
    function resetSnacks() {
        if (confirm("Reset?")) { localStorage.removeItem('mySnacks'); loadSnacksFromStorage(); }
    }
    function renderSnackEditorList() {
        const list = document.getElementById('snackListDisplay'); list.innerHTML = '';
        snackDB.forEach((item, index) => {
            const div = document.createElement('div'); div.className = 'snack-item';
            div.innerHTML = `<div class="snack-info"><span>${item.icon}</span><span>${item.name} <small style="color:#777">(${item.type})</small></span></div><button class="delete-btn" onclick="deleteSnack(${index})">üóë</button>`;
            list.appendChild(div);
        });
    }

    // --- INTRO & CORE ---
    function forceStartApp() {
        if(introDone) return;
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('mainMarquee').classList.remove('in-center');
        const sign = document.getElementById('cinemaSign');
        sign.classList.add('visible'); sign.classList.add('stable-on');
        document.getElementById('mainContent').classList.add('fade-in');
        introDone = true;
    }
    function startIntroSequence() {
        if(introDone) return;
        const img = document.getElementById('introGif');
        if (introGifs.length > 0) { 
            img.src = introGifs[Math.floor(Math.random() * introGifs.length)];
            img.onload = () => { img.classList.add('loaded'); };
            img.onerror = () => { console.log("GIF Error"); forceStartApp(); };
        } else { forceStartApp(); return; }
        
        setTimeout(() => {
            if(introDone) return;
            document.getElementById('loadingOverlay').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                const sign = document.getElementById('cinemaSign');
                sign.classList.add('visible');
                setTimeout(() => {
                    sign.classList.add('flicker-start');
                    setTimeout(() => {
                        sign.classList.remove('flicker-start'); sign.classList.add('stable-on');
                        document.getElementById('mainMarquee').classList.remove('in-center');
                        setTimeout(() => { document.getElementById('mainContent').classList.add('fade-in'); introDone = true; }, 2000);
                    }, 2800);
                }, 500);
            }, 2000 + PAUSE_DARK_SCREEN);
        }, GIF_DURATION);
    }

    function selectSnackPref(val, el) { 
        // Legacy Support falls gebraucht, aber neue Logik nutzt toggleSnackType
    }

    function updateUI() {
        const mode = document.getElementById('appMode').value;
        const mP = [document.getElementById('mandatoryFilters')]; // Optional ist jetzt im Mandatory Block versteckt
        const sP = document.getElementById('snackFilters');
        const mC = document.getElementById('mediaCard'); 
        const sC = document.getElementById('snackCard');
        if(mode==='snack'){ mP.forEach(e=>e.classList.add('hidden')); sP.classList.remove('hidden'); mC.style.display='none'; } 
        else { mP.forEach(e=>e.classList.remove('hidden')); if(mode==='media'){ sP.classList.add('hidden'); sC.style.display='none'; } else { sP.classList.remove('hidden'); } }
    }

    function updateRuntimeDisplay(val) { document.getElementById('runtimeVal').innerText = val == 240 ? "Alle" : `<= ${val} Min`; }
    function populateYearPicker() { const s = document.getElementById('minYearSelect'); const cY = new Date().getFullYear(); for(let i=cY; i>=1900; i--) { const o = document.createElement('option'); o.value = i; o.innerText = i; s.appendChild(o); } }
    
    async function loadCountries() { 
        try { const r=await fetch(`https://api.themoviedb.org/3/configuration/countries?api_key=${API_KEY}&language=de`); const d=await r.json(); d.sort((a,b)=>a.native_name.localeCompare(b.native_name)); 
        const s=document.getElementById('countrySelect'); const f=(cc)=>cc.toUpperCase().replace(/./g, c=>String.fromCodePoint(c.charCodeAt(0)+127397)); 
        d.forEach(c=>{ const o=document.createElement('option'); o.value=c.iso_3166_1; o.setAttribute('data-name',c.native_name); o.innerText=`${f(c.iso_3166_1)} ${c.native_name}`; if(c.iso_3166_1==='DE')o.selected=true; s.appendChild(o); }); 
        } catch(e){} 
    }
    
    async function loadGenres(typeOverride) {
        // Nutze den ersten ausgew√§hlten Typ f√ºr die Genres, oder 'movie' als default
        const type = typeOverride || selectedMediaTypes[0] || 'movie'; 
        const c=document.getElementById('genreBox'); c.innerHTML='Lade...'; state.selectedGenres=[]; 
        try{ 
            if(!state.genres[type] || state.genres[type].length===0){ 
                const r=await fetch(`https://api.themoviedb.org/3/genre/${type}/list?api_key=${API_KEY}&language=de`); 
                const d=await r.json(); state.genres[type]=d.genres; 
            } 
            c.innerHTML=''; 
            state.genres[type].forEach(g=>{ const ch=document.createElement('div'); ch.className='chip'; ch.innerText=g.name; ch.onclick=()=>{ ch.classList.toggle('active'); if(state.selectedGenres.includes(g.id)) state.selectedGenres=state.selectedGenres.filter(id=>id!==g.id); else state.selectedGenres.push(g.id); }; c.appendChild(ch); }); 
        }catch(e){} 
    }

    async function startGeneration() {
        const btn = document.getElementById('genBtn'); btn.disabled=true; btn.innerText="‚è≥ Suche l√§uft...";
        const mode = document.getElementById('appMode').value;
        try { if(mode !== 'snack') await generateMedia(); if(mode !== 'media') generateSnack(); } catch(e){console.error(e);alert("Fehler!");} 
        btn.disabled=false; btn.innerText="üé≤ Vorschlag generieren üé≤";
    }

    async function generateMedia() {
        // Pr√ºfen ob mind. 1 Typ gew√§hlt ist
        if(selectedMediaTypes.length === 0) { alert("Bitte w√§hle Film oder Serie aus!"); return; }
        
        // Zuf√§lligen Typ ausw√§hlen aus den aktiven
        const type = selectedMediaTypes[Math.floor(Math.random() * selectedMediaTypes.length)];
        
        const mr=document.getElementById('minRating').value; const mv=document.getElementById('minVotes').value; const mrt=document.getElementById('maxRuntime').value; const my=document.getElementById('minYearSelect').value; const cc=document.getElementById('countrySelect').value; const cn=document.getElementById('countrySelect').options[document.getElementById('countrySelect').selectedIndex].getAttribute('data-name');
        
        let u=`https://api.themoviedb.org/3/discover/${type}?api_key=${API_KEY}&language=de-DE&sort_by=popularity.desc&vote_average.gte=${mr}&vote_count.gte=${mv}&watch_region=${cc}`;
        if(state.selectedGenres.length>0) u+=`&with_genres=${state.selectedGenres.join(',')}`; if(mrt<240) u+=`&with_runtime.lte=${mrt}`; 
        if(my) { const d=type==='movie'?'primary_release_date.gte':'first_air_date.gte'; u+=`&${d}=${my}-01-01`; }
        
        const cr=await fetch(u); const cd=await cr.json(); if(!cd.results||cd.total_results===0){alert("Nichts gefunden!");return;}
        const mp=Math.min(cd.total_pages,50); const rp=Math.floor(Math.random()*mp)+1; const fr=await fetch(`${u}&page=${rp}`); const fd=await fr.json(); const i=fd.results[Math.floor(Math.random()*fd.results.length)];
        await fetchDetails(i,type,cc,cn);
    }

    async function fetchDetails(i,t,cc,cn) {
        const l=document.getElementById('trailerLang').value; 
        let vr=await fetch(`https://api.themoviedb.org/3/${t}/${i.id}/videos?api_key=${API_KEY}&language=${l}`); let vd=await vr.json(); let tr=vd.results.find(v=>v.site==='YouTube'&&v.type==='Trailer');
        if(!tr&&l==='de'){ vr=await fetch(`https://api.themoviedb.org/3/${t}/${i.id}/videos?api_key=${API_KEY}&language=en-US`); vd=await vr.json(); tr=vd.results.find(v=>v.site==='YouTube'&&v.type==='Trailer'); }
        const pr=await fetch(`https://api.themoviedb.org/3/${t}/${i.id}/watch/providers?api_key=${API_KEY}`); const pd=await pr.json(); const lp=pd.results[cc]||{};
        const fo={ title:i.title||i.name, desc:i.overview||"Keine Info.", rating:i.vote_average.toFixed(1), votes:i.vote_count, year:(i.release_date||i.first_air_date||"").substring(0,4), poster:i.poster_path?`https://image.tmdb.org/t/p/w300${i.poster_path}`:null, trailerId:tr?tr.key:null, providers:lp, countryName:cn };
        if(state.media.index<state.media.history.length-1) state.media.history=state.media.history.slice(0,state.media.index+1); state.media.history.push(fo); state.media.index++; renderMedia(fo);
    }

    function renderMedia(i) {
        document.getElementById('mediaCard').style.display='flex'; document.getElementById('mTitle').innerText=i.title; document.getElementById('mRating').innerText=i.rating; document.getElementById('mVotes').innerText=`(${i.votes})`; document.getElementById('mYear').innerText=i.year; document.getElementById('mDesc').innerText=i.desc;
        const pi=document.getElementById('mPoster'); if(i.poster){pi.src=i.poster;pi.style.display='block';}else{pi.style.display='none';}
        const pc=document.getElementById('mProvidersContent'); pc.innerHTML=''; document.getElementById('providerHeader').innerText=`Verf√ºgbar in ${i.countryName} als...`;
        let hp=false; [{k:'flatrate',l:'Flatrate:'},{k:'rent',l:'Leihe:'},{k:'buy',l:'Kauf:'}].forEach(t=>{ if(i.providers[t.k]){ hp=true; const r=document.createElement('div'); r.className='prov-cat'; const lb=document.createElement('span'); lb.className='prov-label'; lb.innerText=t.l; r.appendChild(lb); const lst=document.createElement('div'); list=document.createElement('div'); lst.className='provider-list'; i.providers[t.k].forEach(p=>{ const im=document.createElement('img'); im.src=`https://image.tmdb.org/t/p/w92${p.logo_path}`; im.className='provider-icon'; lst.appendChild(im); }); r.appendChild(lst); pc.appendChild(r); } });
        if(!hp) pc.innerHTML='<div style="font-size:0.8rem;color:#777;">Keine Infos.</div>';
        const vc=document.getElementById('mVideo'); vc.innerHTML=i.trailerId?`<iframe src="https://www.youtube.com/embed/${i.trailerId}?rel=0" frameborder="0" allowfullscreen></iframe>`:`<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#555;">Kein Trailer</div>`;
        updateNavState('media');
    }

    function generateSnack() {
        // Aktive Chips auslesen
        const activeChips = document.querySelectorAll('#snackChipContainer .chip.active');
        const activeTypes = Array.from(activeChips).map(c => c.dataset.type);

        if(activeTypes.length === 0) { alert("Bitte w√§hle mindestens S√º√ü oder Salzig!"); return; }

        let pool = snackDB.filter(s => activeTypes.includes(s.type));
        
        if (pool.length === 0) { alert("Keine Snacks in dieser Kategorie gefunden!"); return; }

        const item = pool[Math.floor(Math.random() * pool.length)];
        if(state.snack.index < state.snack.history.length - 1) state.snack.history = state.snack.history.slice(0, state.snack.index + 1); 
        state.snack.history.push(item); state.snack.index++; 
        renderSnack(item);
    }

    function renderSnack(i) {
        document.getElementById('snackCard').style.display='flex'; const m=document.getElementById('appMode').value; const h=document.getElementById('snackDynamicHeader');
        if(m==='both'){ h.innerText="Wie w√§r's dazu mit..."; h.style.color='#ccc'; h.style.fontSize='1.2rem'; } else { h.innerText="Snack-Time! ü§§ü•≥"; h.style.color='var(--primary)'; h.style.fontSize='1.8rem'; h.style.fontWeight='bold'; }
        document.getElementById('sName').innerText=i.name; document.getElementById('sEmoji').innerText=i.icon; document.getElementById('sDesc').innerText=i.desc; updateNavState('snack');
    }

    function navigate(t,d) { const s=state[t]; const n=s.index+d; if(d===1&&n>=s.history.length){ if(t==='media') startGeneration(); else generateSnack(); } else if(n>=0){ s.index=n; if(t==='media') renderMedia(s.history[n]); else renderSnack(s.history[n]); } }
    function updateNavState(t) { document.getElementById(t==='media'?'btnMPrev':'btnSPrev').disabled=state[t].index<=0; }
</script>
</body>
</html>